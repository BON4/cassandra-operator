project: cassandra-tests
kill-timeout: 90m
workers: 1

environment:
  CI: "$(HOST: echo $CI)"
  CONCIERGE_JUJU_CHANNEL/juju_3_5: 3.5/stable
  CONCIERGE_JUJU_CHANNEL/juju_3_6: 3.6/stable

backends:
  lxd:
    type: adhoc
    allocate: |
      BASE="${BASE:-noble}"
      VM_NAME="${VM_NAME:-ubuntu-${BASE}-${RANDOM}}"
      DISK="${DISK:-20}"
      CPU="${CPU:-4}"
      MEM="${MEM:-8}"

      cloud_config="#cloud-config
      ssh_pwauth: true
      users:
        - default
        - name: runner
          plain_text_passwd: $SPREAD_PASSWORD
          lock_passwd: false
          sudo: ALL=(ALL) NOPASSWD:ALL
      "

      lxc launch --vm \
        "ubuntu:${BASE}" \
        "${VM_NAME}" \
        -c user.user-data="$(cat "$cloud_config")" \
        -c limits.cpu="${CPU}" \
        -c limits.memory="${MEM}GiB" \
        -d root,size="${DISK}GiB"

      # Wait for the spread user
      while ! lxc exec "${VM_NAME}" -- id -u spread &>/dev/null; do sleep 0.5; done

      rm "$cloud_config"

      # Set the instance address for spread
      ADDRESS "$(lxc ls -f csv | grep "${VM_NAME}" | cut -d"," -f3 | cut -d" " -f1)"
    discard: |
      instance_name="$(lxc ls -f csv | grep $SPREAD_SYSTEM_ADDRESS | cut -f1 -d",")"
      lxc delete -f $instance_name

    systems:
      - ubuntu-24.04:
          username: spread
          workers: 1

  github-ci:
    type: adhoc
    # Only run on CI
    manual: true
    # HACK: spread requires runners to be accessible via SSH
    # Configure local sshd & instruct spread to connect to the same machine spread is running on
    # (spread cannot provision GitHub Actions runners, so we provision a GitHub Actions runner for
    # each spread job & select a single job when running spread)
    # Derived from https://github.com/jnsgruk/zinc-k8s-operator/blob/a21eae8399eb3b9df4ddb934b837af25ef831976/spread.yaml#L47
    allocate: |
      sudo tee /etc/ssh/sshd_config.d/10-spread-github-ci.conf << 'EOF'
      PasswordAuthentication yes
      PermitEmptyPasswords yes
      EOF

      sudo passwd --delete "$USER"

      ADDRESS localhost
    # HACK: spread does not pass environment variables set on runner
    # Manually pass specific environment variables
    environment:
      CI: '$(HOST: echo $CI)'
    systems:
      - ubuntu-24.04:
          username: spread
          workers: 1

suites:
  tests/spread/:
    summary: Spread tests

exclude:
  - .coverage
  - .git
  - .github
  - .pytest_cache
  - .ruff_cache
  - .tox
  - .venv

# this needs to be under /root because spread executes the test scripts
# as root, which means that juju can only see files in root's
# home directory due to snap confinement.
path: /root/proj


kill-timeout: 1h

prepare: |
  snap refresh --hold
  chown -R root:root "$SPREAD_PATH"
  cd "$SPREAD_PATH"
  snap install --classic concierge

  # Install charmcraft & pipx (on lxd-vm backend)
  concierge prepare --trace

  pipx install tox poetry
prepare-each: |
  cd "$SPREAD_PATH"
  if [[ $SPREAD_VARIANT == *"juju29"* ]]
  then
    # Each version of python-libjuju is only compatible with one major Juju version
    # Override python-libjuju version pinned in poetry.lock
    poetry add --lock --group integration juju@^2
  fi
  # `concierge prepare` needs to be run for each spread job in case Juju version changed
  concierge prepare --trace

  # Unable to set constraint on all models because of Juju bug:
  # https://bugs.launchpad.net/juju/+bug/2065050
  juju set-model-constraints arch="$(dpkg --print-architecture)"